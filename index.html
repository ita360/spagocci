<!DOCTYPE html>
<html lang="it">
<head>
<link rel="icon" href="https://github.com/spagocci/recensioni/blob/main/icona.png" type="image/png">
<meta charset="UTF-8">
<title>Spagocci 1.10</title>
<style>
.slider-label {
  display: block;
  margin-bottom: 8px;
  font-size: 1.1em;
  font-weight: bold;
}
.slider-label input[type="range"] {
  width: 100%;
}

body {
  font-family: sans-serif;
  padding: 20px;
  background: #f9f9f9;
}
h1 {
  margin-bottom: 10px;
}
button {
  margin-bottom: 20px;
  padding: 8px 12px;
  font-size: 1em;
  cursor: pointer;
}
#timer {
  font-size: 1.2em;
  font-weight: bold;
  color: #b30000;
  margin-left: 10px;
}
.row {
  display: flex;
  gap: 0;
  height: 80vh;
}
.column {
  flex: 1;
  background: linear-gradient(to bottom, #fff, #f0f0f0);
  padding: 20px;
  border-radius: 20px;
  border: 4px solid #b30000;
  box-shadow:
    inset 0 0 10px rgba(0, 0, 0, 0.1),
    0 4px 10px rgba(0, 0, 0, 0.2);
  overflow-y: auto;
  margin-bottom: 10px;
  transition: transform 0.1s ease, box-shadow 0.2s ease;
  min-width: 100px;
}
.column:hover {
  box-shadow:
    inset 0 0 10px rgba(0, 0, 0, 0.15),
    0 6px 14px rgba(0, 0, 0, 0.3);
}
.column:active {
  transform: scale(0.98);
  box-shadow:
    inset 0 0 6px rgba(0, 0, 0, 0.2),
    0 2px 6px rgba(0, 0, 0, 0.2);
}
img {
  max-width: 200px;
  display: block;
  margin-top: 10px;
}
small {
  color: #666;
  font-size: 0.9em;
}
.column a {
  color: #000;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: none;
}
.item {
  margin-bottom: 20px;
  padding: 15px;
  background: linear-gradient(to bottom, #fefefe, #eaeaea);
  border-radius: 20px;
  border: 4px solid #b30000;
  box-shadow:
    inset 0 0 10px rgba(0, 0, 0, 0.1),
    0 4px 10px rgba(0, 0, 0, 0.2);
  transition: transform 0.1s ease, box-shadow 0.2s ease;
}
.item:hover {
  box-shadow:
    inset 0 0 10px rgba(0, 0, 0, 0.15),
    0 6px 14px rgba(0, 0, 0, 0.3);
}
.item:active {
  transform: scale(0.98);
  box-shadow:
    inset 0 0 6px rgba(0, 0, 0, 0.2),
    0 2px 6px rgba(0, 0, 0, 0.2);
}
.resizer {
  width: 14px;
  background: #b000;
  cursor: col-resize;
  user-select: none;
  touch-action: none;
}
</style>
</head>

<body>
  <h1>
    <a href="https://sites.google.com/view/davidespagocci/informazioni">iSTRUZiONi</a> -
    <a href="https://discord.gg/zE25rQfg">DiSCORD</a> -
    <a href="https://whatsapp.com/channel/0029Vb6FyJ88qIzyi9nRtV2O">WhatsApp</a> -
    (in arrivo Telegram e altri)
  </h1>

  <button id="toggleAudio">üîà Audio: Attivo</button>
  <button id="toggleRefresh">‚è∏ Stop Refresh</button>
  <span id="timer">Refresh in: 120s</span>

  <audio id="soundGenerale" src="https://www.myinstants.com/media/sounds/tutti.wav" preload="auto"></audio>
  <audio id="soundPochiSecondi" src="https://github.com/spagocci/recensioni/blob/main/perte.mp3" preload="auto"></audio>

  <div class="row">
    <div class="column" id="canaleSinistra">
      <label class="slider-label">
        Larghezza #tutti:
        <input type="range" id="sliderSinistra" min="100" max="800">
        <span id="valSinistra"></span>
      </label>
      <h2>#tutti</h2>
      <div class="contenuto" id="contenutoSinistra"></div>
    </div>

    <div class="resizer" id="resizer1"></div>

    <div class="column" id="canaleDestra">
      <label class="slider-label">
        Larghezza #perpochisecondi:
        <input type="range" id="sliderDestra" min="100" max="800">
        <span id="valDestra"></span>
      </label>
      <h2>#perpochisecondi</h2>
      <div class="contenuto" id="contenutoDestra"></div>
    </div>

    <div class="resizer" id="resizer2"></div>

    <div class="column" id="canaleFiltrati">
      <label class="slider-label">
        Larghezza #filtrati:
        <input type="range" id="sliderFiltrati" min="100" max="800">
        <span id="valFiltrati"></span>
      </label>
      <h2>#filtrati</h2>
      <div class="contenuto" id="contenutoFiltrati"></div>
    </div>
  </div>

<script>
// === TIMER E REFRESH ===
let refreshInterval = 120; // secondi per il refresh completo
let timeLeft = refreshInterval;
let refreshActive = true;
const timerDisplay = document.getElementById("timer");
const toggleButton = document.getElementById("toggleRefresh");

function updateTimerDisplay() {
  timerDisplay.textContent = `Refresh in: ${timeLeft}s`;
}

// Aggiornamento timer ogni secondo
setInterval(() => {
  if (!refreshActive) return;
  timeLeft--;
  if (timeLeft <= 0) {
    location.reload();
  }
  updateTimerDisplay();
}, 1000);

// Toggle Start/Stop solo per il refresh completo
toggleButton.addEventListener("click", () => {
  refreshActive = !refreshActive;
  toggleButton.textContent = refreshActive ? "‚è∏ Stop Refresh" : "‚ñ∂Ô∏è Riprendi Refresh";
});

// === VARIABILI E AUDIO ===
const valSinistra = document.getElementById('valSinistra');
const valDestra = document.getElementById('valDestra');
const valFiltrati = document.getElementById('valFiltrati');
const sliderSinistra = document.getElementById('sliderSinistra');
const sliderDestra = document.getElementById('sliderDestra');
const sliderFiltrati = document.getElementById('sliderFiltrati');

let audioAttivo = true;
let messaggiVisualizzati = new Set(JSON.parse(localStorage.getItem('messaggiVisualizzati') || '[]'));
let primaVolta = messaggiVisualizzati.size === 0;

document.getElementById('toggleAudio').addEventListener('click', () => {
  audioAttivo = !audioAttivo;
  document.getElementById('toggleAudio').textContent = audioAttivo ? 'üîà Audio: Attivo' : 'üîá Audio: Muto';
});

// === CARICAMENTO DATI OGNI 10 SECONDI (sempre attivo) ===
function caricaCatalogo() {
  const timestamp = new Date().getTime();
  fetch(`https://spagocci.github.io/recensioni/data.json?t=${timestamp}`)
    .then(res => {
      if (!res.ok) throw new Error('File non trovato o accesso negato');
      return res.json();
    })
    .then(data => {
      if (!Array.isArray(data)) throw new Error('Formato JSON non valido');
      data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      const contenutoSinistra = document.getElementById('contenutoSinistra');
      const contenutoDestra = document.getElementById('contenutoDestra');
      const contenutoFiltrati = document.getElementById('contenutoFiltrati');

      contenutoSinistra.innerHTML = '';
      contenutoDestra.innerHTML = '';
      contenutoFiltrati.innerHTML = '';

      data.forEach(item => {
        const isNuovo = !messaggiVisualizzati.has(item.id);
        messaggiVisualizzati.add(item.id);
        localStorage.setItem('messaggiVisualizzati', JSON.stringify([...messaggiVisualizzati]));

        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          ${item.link ? `<p><a href="${item.link}" target="_blank">${item.text}</a></p>` : `<p>${item.text}</p>`}
          ${item.image ? `<img src="${item.image}" alt="Immagine"/>` : ''}
          <small>${new Date(item.timestamp).toLocaleString()}</small>
        `;

        const soundGenerale = document.getElementById('soundGenerale');
        const soundPochiSecondi = document.getElementById('soundPochiSecondi');

        if (item.sourceChannel === '1432128848534962402') {
          contenutoSinistra.appendChild(div);
          if (!primaVolta && audioAttivo && isNuovo && soundGenerale) soundGenerale.play().catch(() => {});
        } else if (item.sourceChannel === '1430829927175032954') {
          contenutoDestra.appendChild(div);
          if (!primaVolta && audioAttivo && isNuovo && soundPochiSecondi) soundPochiSecondi.play().catch(() => {});
        } else if (item.sourceChannel === '1431551820509089842') {
          contenutoFiltrati.appendChild(div);
          if (!primaVolta && audioAttivo && isNuovo && soundGenerale) soundGenerale.play().catch(() => {});
        }
      });
    })
    .catch(err => {
      document.getElementById('contenutoSinistra').innerHTML = `<p style="color:red;">‚ùå Errore: ${err.message}</p>`;
      document.getElementById('contenutoDestra').innerHTML = `<p style="color:red;">‚ùå Errore: ${err.message}</p>`;
      document.getElementById('contenutoFiltrati').innerHTML = `<p style="color:red;">‚ùå Errore: ${err.message}</p>`;
      console.error('Errore nel caricamento:', err);
    });
}

caricaCatalogo();
setInterval(caricaCatalogo, 10000);

// === FUNZIONI SLIDER E RESIZE ===
function makeResizable(resizer, leftCol, rightCol, keyLeft, keyRight) {
  let x = 0;
  let leftWidth = 0;

  const mouseDownHandler = function(e) {
    x = e.clientX || (e.touches && e.touches[0].clientX);
    leftWidth = leftCol.getBoundingClientRect().width;

    document.addEventListener('mousemove', mouseMoveHandler);
    document.addEventListener('mouseup', mouseUpHandler);
    document.addEventListener('touchmove', mouseMoveHandler);
    document.addEventListener('touchend', mouseUpHandler);
  };

  const mouseMoveHandler = function(e) {
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const dx = clientX - x;
    leftCol.style.flex = 'none';
    rightCol.style.flex = 'none';
    leftCol.style.width = `${leftWidth + dx}px`;
  };

  const mouseUpHandler = function() {
    localStorage.setItem(keyLeft, leftCol.offsetWidth);
    localStorage.setItem(keyRight, rightCol.offsetWidth);

    document.removeEventListener('mousemove', mouseMoveHandler);
    document.removeEventListener('mouseup', mouseUpHandler);
    document.removeEventListener('touchmove', mouseMoveHandler);
    document.removeEventListener('touchend', mouseUpHandler);
  };

  resizer.addEventListener('mousedown', mouseDownHandler);
  resizer.addEventListener('touchstart', mouseDownHandler);
}

function restoreWidths() {
  const sinistra = document.getElementById('canaleSinistra');
  const destra = document.getElementById('canaleDestra');
  const filtrati = document.getElementById('canaleFiltrati');

  const wSinistra = localStorage.getItem('width_sinistra');
  const wDestra = localStorage.getItem('width_destra');
  const wFiltrati = localStorage.getItem('width_filtrati');

  if (wSinistra) {
    sinistra.style.flex = 'none';
    sinistra.style.width = wSinistra + 'px';
    sliderSinistra.value = wSinistra;
    valSinistra.textContent = wSinistra + 'px';
  }
  if (wDestra) {
    destra.style.flex = 'none';
    destra.style.width = wDestra + 'px';
    sliderDestra.value = wDestra;
    valDestra.textContent = wDestra + 'px';
  }
  if (wFiltrati) {
    filtrati.style.flex = 'none';
    filtrati.style.width = wFiltrati + 'px';
    sliderFiltrati.value = wFiltrati;
    valFiltrati.textContent = wFiltrati + 'px';
  }
}

makeResizable(document.getElementById('resizer1'), document.getElementById('canaleSinistra'), document.getElementById('canaleDestra'), 'width_sinistra', 'width_destra');
makeResizable(document.getElementById('resizer2'), document.getElementById('canaleDestra'), document.getElementById('canaleFiltrati'), 'width_destra', 'width_filtrati');
restoreWidths();

sliderSinistra.addEventListener('input', e => {
  const val = e.target.value;
  valSinistra.textContent = val + 'px';
  const col = document.getElementById('canaleSinistra');
  col.style.flex = 'none';
  col.style.width = val + 'px';
  localStorage.setItem('width_sinistra', val);
});

sliderDestra.addEventListener('input', e => {
  const val = e.target.value;
  valDestra.textContent = val + 'px';
  const col = document.getElementById('canaleDestra');
  col.style.flex = 'none';
  col.style.width = val + 'px';
  localStorage.setItem('width_destra', val);
});

sliderFiltrati.addEventListener('input', e => {
  const val = e.target.value;
  valFiltrati.textContent = val + 'px';
  const col = document.getElementById('canaleFiltrati');
  col.style.flex = 'none';
  col.style.width = val + 'px';
  localStorage.setItem('width_filtrati', val);
});
</script>
</body>
</html>

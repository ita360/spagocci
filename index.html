<!DOCTYPE html>
<html lang="it">
<head>
<link rel="icon" href="https://github.com/spagocci/recensioni/blob/main/icona.png" type="image/png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spagocci 1.27 - Frasi con spazi + Ordine colonne</title>
<style>
body {
  font-family: sans-serif;
  padding: 20px;
  background: #f9f9f9;
}
button {
  margin-bottom: 10px;
  padding: 8px 12px;
  font-size: 1em;
  cursor: pointer;
}
#timer {
  font-size: 1.2em;
  font-weight: bold;
  color: #b30000;
  margin-left: 10px;
}
#filtroParole {
  width: 100%;
  max-width: 400px;
  padding: 8px 10px;
  margin: 10px 0 10px 0;
  font-size: 1em;
  border: 2px solid #b30000;
  border-radius: 10px;
}
#conteggioNascosti {
  display: inline-block;
  margin-bottom: 15px;
  font-size: 1em;
  font-weight: bold;
  color: #b30000;
}
.row {
  display: flex;
  gap: 10px;
  height: 80vh;
}
.column {
  flex: 1;
  background: linear-gradient(to bottom,#fff,#f0f0f0);
  padding: 20px;
  border-radius: 20px;
  border: 4px solid #b30000;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.2);
  overflow-y: auto;
}
.contenuto {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 15px;
}
.item {
  background:linear-gradient(to bottom,#fefefe,#eaeaea);
  border-radius:20px;
  border:4px solid #b30000;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.2);
  padding:12px;
  display:flex;
  flex-direction:column;
  transition: opacity 0.2s ease;
}
.item-content {
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  gap:10px;
}
img { max-width:90%; border-radius:12px; }
.price-big { font-size:1em; font-weight:bold; color:#009900; }
.column a { color:#000; text-decoration:none; font-weight:bold; }
.column a:hover { text-decoration:underline; }
@media (max-width:900px){ .row { flex-direction:column; height:auto; } }

/* === MODALE EDIT PAROLE === */
#modaleParole {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
#modaleContenuto {
  background: #fff;
  padding: 20px;
  border-radius: 15px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}
#modaleContenuto textarea {
  width: 100%;
  height: 120px;
  font-size: 1em;
  padding: 8px;
  border-radius: 8px;
  border: 2px solid #b30000;
  resize: none;
}
#modaleContenuto button {
  margin-top: 10px;
  margin-right: 10px;
}
</style>
</head>

<body>
<p class="link-bar">
  <a href="https://discord.gg/zE25rQfg">ü§ñDiSCORD</a> -
  <a href="https://sites.google.com/view/davidespagocci/informazioni">üìòiSTRUZiONi</a> -
  <a href="https://whatsapp.com/channel/0029Vb6FyJ88qIzyi9nRtV2O">üì¶WHATSAPP</a> -
  <a href="https://www.ebay.it/sch/i.html?_dkr=1&_ssn=davidespagocci">üõçÔ∏èEBAY</a>
</p>

<input id="filtroParole" type="text" placeholder="Scrivi parole o FRASI da NASCONDERE (es: lampada,per finestre,torta)">
<button id="btnGestisciParole">‚úèÔ∏è Gestisci Parole Nascoste</button>
<div id="conteggioNascosti">üîï Oggetti nascosti: 0</div>

<button id="toggleAudio">üîà Attiva Notifiche Audio</button>
<button id="toggleRefresh">‚è∏ Ferma aggiornamento</button>
<button id="btnSoloMigliori">‚≠êSolo i <b>Migliori oggetti</b></button>
<button id="btnValle">Chiedi Prezzo pi√π Basso</button>
<span id="timer">Agg. tra: 60 s</span>

<!-- === MODALE === -->
<div id="modaleParole">
  <div id="modaleContenuto">
    <h3>‚úèÔ∏è Parole Nascoste</h3>
    <p>Inserisci parole o frasi separate da virgole o punti e virgola:</p>
    <textarea id="modaleTextarea"></textarea><br>
    <button id="salvaParole">üíæ Salva</button>
    <button id="cancellaParole">üóëÔ∏è Cancella Tutto</button>
    <button id="chiudiModale">‚ùå Chiudi</button>
  </div>
</div>

<!-- === AUDIO === -->
<audio id="audioGenerale" src="https://raw.githubusercontent.com/spagocci/recensioni/main/tutti.mp3" preload="auto"></audio>
<audio id="audioPochiSecondi" src="https://raw.githubusercontent.com/spagocci/recensioni/main/perte.mp3" preload="auto"></audio>
<audio id="audioAttivate" src="https://raw.githubusercontent.com/spagocci/recensioni/main/attivate.mp3" preload="auto"></audio>
<audio id="audioDisattivate" src="https://raw.githubusercontent.com/spagocci/recensioni/main/disattivate.mp3" preload="auto"></audio>
<audio id="audioAggAttivato" src="https://raw.githubusercontent.com/spagocci/recensioni/main/aggattivato.mp3" preload="auto"></audio>
<audio id="audioAggDisattivato" src="https://raw.githubusercontent.com/spagocci/recensioni/main/aggdisattivato.mp3" preload="auto"></audio>
<audio id="audioValle" src="https://raw.githubusercontent.com/spagocci/recensioni/main/valledilacrime.mp3" preload="auto"></audio>

<!-- === ORDINE COLONNE: tutti -> perpochisecondi -> filtrati === -->
<div class="row">
  <div class="column" id="canaleSinistra">
    <h2>#tutti</h2>
    <div class="contenuto" id="contenutoSinistra"></div>
  </div>
  <div class="column" id="canaleFiltrati">
    <h2>#filtrati</h2>
    <div class="contenuto" id="contenutoFiltrati"></div>
  </div>
</div>
  <div class="column" id="canaleDestra">
    <h2>#perpochisecondi</h2>
    <div class="contenuto" id="contenutoDestra"></div>
  </div>


<script>
let refreshInterval = 60;
let timeLeft = refreshInterval;
let refreshActive = true;
const timerDisplay = document.getElementById("timer");
const toggleButton = document.getElementById("toggleRefresh");
const conteggioNascosti = document.getElementById('conteggioNascosti');
const audioAggAttivato = document.getElementById("audioAggAttivato");
const audioAggDisattivato = document.getElementById("audioAggDisattivato");

function updateTimerDisplay(){ timerDisplay.textContent=`Agg tra: ${timeLeft}s`; }
setInterval(()=>{ if(!refreshActive)return; timeLeft--; if(timeLeft<=0)location.reload(); updateTimerDisplay(); },1000);

toggleButton.addEventListener("click", async ()=>{
  refreshActive=!refreshActive;
  toggleButton.textContent=refreshActive?"‚è∏ Ferma aggiornamento":"‚ñ∂Ô∏è Riprendi aggiornamento";
  try {
    if (refreshActive) await audioAggAttivato.play(); else await audioAggDisattivato.play();
  } catch (e) { console.warn("‚ö†Ô∏è Errore audio aggiornamento:", e.message); }
});

let audioAttivo = localStorage.getItem('audioAttivo') === 'true';
let messaggiVisualizzati = new Set(JSON.parse(localStorage.getItem('messaggiVisualizzati') || '[]'));
let primaVolta = messaggiVisualizzati.size === 0;

const toggleAudioBtn = document.getElementById('toggleAudio');
const audioGenerale = document.getElementById('audioGenerale');
const audioPochiSecondi = document.getElementById('audioPochiSecondi');
const audioAttivate = document.getElementById('audioAttivate');
const audioDisattivate = document.getElementById('audioDisattivate');
const audioValle = document.getElementById('audioValle');
const btnValle = document.getElementById('btnValle');

function aggiornaBottoneAudio() {
  toggleAudioBtn.textContent = audioAttivo ? "üîá Disattiva Notifiche Audio" : "üîà Attiva Notifiche Audio";
}
aggiornaBottoneAudio();

toggleAudioBtn.addEventListener('click', async () => {
  audioAttivo = !audioAttivo;
  localStorage.setItem('audioAttivo', audioAttivo);
  aggiornaBottoneAudio();
  try {
    await audioGenerale.play(); audioGenerale.pause(); audioGenerale.currentTime = 0;
    await audioPochiSecondi.play(); audioPochiSecondi.pause(); audioPochiSecondi.currentTime = 0;
    if (audioAttivo) await audioAttivate.play(); else await audioDisattivate.play();
  } catch (e) { console.warn('‚ö†Ô∏è Errore durante riproduzione suono di conferma:', e.message); }
});

btnValle.addEventListener('click', async ()=>{ try { await audioValle.play(); } catch (e) { console.warn('‚ö†Ô∏è Errore riproduzione ValleDiLacrime:', e.message); } });

function caricaCatalogo(){
  const timestamp=new Date().getTime();
  fetch(`https://spagocci.github.io/recensioni/data.json?t=${timestamp}`)
  .then(res=>res.json())
  .then(data=>{
    data.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
    const sinistra=document.getElementById('contenutoSinistra');
    const destra=document.getElementById('contenutoDestra');
    const filtrati=document.getElementById('contenutoFiltrati');
    sinistra.innerHTML=destra.innerHTML=filtrati.innerHTML='';

    data.forEach(item=>{
      const isNuovo=!messaggiVisualizzati.has(item.id);
      messaggiVisualizzati.add(item.id);
      localStorage.setItem('messaggiVisualizzati',JSON.stringify([...messaggiVisualizzati]));

      const div=document.createElement('div');
      div.className='item';
      div.innerHTML=`<div class="item-content">
        ${item.image?`<img src="${item.image}" alt="Immagine">`:''}
        ${item.price?`<div class="price-big">${item.price}</div>`:''}
        <div>${item.link?`<p><a href="${item.link}" target="_blank">${item.text}</a></p>`:`<p>${item.text}</p>`}
        <small>${new Date(item.timestamp).toLocaleString()}</small></div>
      </div>`;

      if(item.sourceChannel==='1432128848534962402'){
        sinistra.appendChild(div);
        if(!primaVolta&&audioAttivo&&isNuovo)audioGenerale.play().catch(()=>{});
      }else if(item.sourceChannel==='1430829927175032954'){
        destra.appendChild(div);
        if(!primaVolta&&audioAttivo&&isNuovo)audioPochiSecondi.play().catch(()=>{});
      }else if(item.sourceChannel==='1431551820509089842'){
        filtrati.appendChild(div);
        if(!primaVolta&&audioAttivo&&isNuovo)audioGenerale.play().catch(()=>{});
      }
    });
    applicaFiltro();
  })
  .catch(err=>{
    ['contenutoSinistra','contenutoDestra','contenutoFiltrati'].forEach(id=>{
      document.getElementById(id).innerHTML=`<p style="color:red;">‚ùå Errore: ${err.message}</p>`;
    });
  });
}
caricaCatalogo();
setInterval(caricaCatalogo,10000);

// === üîç FILTRO PAROLE PERSISTENTE con FRASI ===
const filtroInput = document.getElementById('filtroParole');
const paroleSalvate = localStorage.getItem('paroleNascondi') || '';
filtroInput.value = paroleSalvate;
if (paroleSalvate.trim().length > 0) applicaFiltro();

filtroInput.addEventListener('input', () => {
  localStorage.setItem('paroleNascondi', filtroInput.value.trim());
  applicaFiltro();
});

function applicaFiltro() {
  const testoFiltro = filtroInput.value.trim().toLowerCase();
  const frasi = testoFiltro.split(/[;,]+/).map(p => p.trim()).filter(p => p.length > 0);

  let nascosti = 0;
  document.querySelectorAll('.item').forEach(el => {
    const testo = ((el.querySelector('p')?.innerText || '') + ' ' +
                   (el.querySelector('.price-big')?.innerText || '')).toLowerCase();
    const contiene = frasi.some(frase => testo.includes(frase));
    el.style.display = contiene ? 'none' : '';
    if (contiene) nascosti++;
  });
  conteggioNascosti.textContent = `üîï Oggetti nascosti: ${nascosti}`;
}

// === ‚úèÔ∏è MODALE GESTIONE PAROLE ===
const modale = document.getElementById('modaleParole');
const textarea = document.getElementById('modaleTextarea');
const btnGestisci = document.getElementById('btnGestisciParole');
const btnSalva = document.getElementById('salvaParole');
const btnChiudi = document.getElementById('chiudiModale');
const btnCancella = document.getElementById('cancellaParole');

btnGestisci.addEventListener('click', () => {
  textarea.value = localStorage.getItem('paroleNascondi') || '';
  modale.style.display = 'flex';
});
btnChiudi.addEventListener('click', ()=> modale.style.display='none');
btnSalva.addEventListener('click', ()=>{
  localStorage.setItem('paroleNascondi', textarea.value.trim());
  filtroInput.value = textarea.value.trim();
  applicaFiltro();
  modale.style.display='none';
});
btnCancella.addEventListener('click', ()=>{
  localStorage.removeItem('paroleNascondi');
  filtroInput.value = '';
  applicaFiltro();
  modale.style.display='none';
});

// === TOGGLE SOLO I MIGLIORI ===
const btnSoloMigliori = document.getElementById('btnSoloMigliori');
let soloMiglioriAttivo = false;
btnSoloMigliori.addEventListener('click', ()=>{
  soloMiglioriAttivo = !soloMiglioriAttivo;
  const canaleSinistra = document.getElementById('canaleSinistra');
  const canaleDestra   = document.getElementById('canaleDestra');
  const canaleFiltrati = document.getElementById('canaleFiltrati');

  if (soloMiglioriAttivo) {
    canaleSinistra.style.display = 'none';
    canaleDestra.style.display = 'block';
    canaleFiltrati.style.display = 'block';
    btnSoloMigliori.textContent = 'üåç TUTTi gli oggetti';
  } else {
    canaleSinistra.style.display = 'block';
    canaleDestra.style.display = 'block';
    canaleFiltrati.style.display = 'block';
    btnSoloMigliori.textContent = '‚≠ê Solo i Migliori oggetti';
  }
});
</script>
</body>
</html>

